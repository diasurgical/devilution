DIABLO_SRC=$(wildcard Source/*.cpp)
DIABLO_OBJ=$(DIABLO_SRC:.cpp=.obj)

PKWARE_SRC=$(wildcard 3rdParty/PKWare/*.cpp)
PKWARE_OBJ=$(PKWARE_SRC:.cpp=.obj)

DIABLOUI_SRC=$(wildcard DiabloUI/*.cpp)
DIABLOUI_OBJ=$(DIABLOUI_SRC:.cpp=.obj)

STORM_SRC=$(wildcard 3rdParty/Storm/Source/*.cpp)
STORM_OBJ=$(STORM_SRC:.cpp=.obj)

all: devilution.exe

VC_DIR=/home/u/_share_/DevStudio/VC
VC_BIN_DIR=$(VC_DIR)/bin
VC_INC_DIR=$(VC_DIR)/include
VC_LIB_DIR=$(VC_DIR)/lib
CL=$(VC_BIN_DIR)/CL.EXE
#LINK=$(VC_BIN_DIR)/LINK.EXE

devilution.exe: $(DIABLO_OBJ) $(PKWARE_OBJ) DiabloUI/DiabloUI.lib 3rdParty/Storm/Source/Storm.lib
	wine $(CL) /nologo /O1 /W3 /MT /I $(VC_INC_DIR) /Fe$@ $(DIABLO_OBJ) $(PKWARE_OBJ) /link /LIBPATH:$(VC_LIB_DIR) advapi32.lib gdi32.lib shell32.lib user32.lib version.lib DiabloUI/DiabloUI.lib 3rdParty/Storm/Source/Storm.lib

%.obj: %.cpp
	wine $(CL) /nologo /c /O1 /W3 /MT /I $(VC_INC_DIR) /Fo$@ $<

# /MT needed for _beginthreadex

# TODO: Check output for /O2

DiabloUI/DiabloUI.lib: $(DIABLOUI_OBJ)
	wine $(CL) /nologo /O1 /W3 /MT /I $(VC_INC_DIR) $(DIABLOUI_OBJ) /link /out:DiabloUI/DiabloUI.dll /nologo /subsystem:windows /dll /machine:I386 /def:"DiabloUI/diabloui.def" /LIBPATH:$(VC_LIB_DIR)

3rdParty/Storm/Source/Storm.lib: $(STORM_OBJ)
	wine $(CL) /nologo /O1 /W3 /MT /I $(VC_INC_DIR) $(STORM_OBJ) /link /out:3rdParty/Storm/Source/Storm.dll /nologo /subsystem:windows /dll /machine:I386 /def:"3rdParty/Storm/Source/Storm.def" /LIBPATH:$(VC_LIB_DIR)

clean:
	rm -f $(DIABLO_OBJ) $(PKWARE_OBJ) $(DIABLOUI_OBJ) $(STORM_OBJ)

.PHONY: clean all
